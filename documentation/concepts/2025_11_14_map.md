# Game Map Design Document

## Status
Ready for Implementation

---

## Overview

A strategic map system for Congress Quest that provides faction-based territorial visualization while maintaining exploration incentives through intelligent fog-of-war mechanics.

### Core Principles
- **Strategic Coordination**: Enable faction members to plan and coordinate attacks
- **Information Warfare**: Create value in reconnaissance and sharing intelligence
- **Exploration Rewards**: Hidden mini-game points encourage physical exploration
- **Indoor-Friendly**: No GPS dependency, works with QR code system

---

## Why a Map is Essential

1. **Faction Coordination** - Players need to see territorial control to plan coordinated attacks
2. **Strategic Depth** - The point level system (1-3) and health mechanics create strategic value that must be visualized
3. **Multi-Floor Navigation** - Without a map, navigating multiple floors would be confusing
4. **Territorial Conflict** - The core game loop is about territory control, which demands visual representation
5. **Physical Presence Still Required** - QR codes ensure the map doesn't bypass game mechanics

---

## Database Architecture

### Point Positions Table
Keeps the `points` table clean by storing spatial data separately:

```sql
CREATE TABLE point_positions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  point_id UUID NOT NULL REFERENCES points(id) ON DELETE CASCADE,
  floor_id INTEGER NOT NULL,
  x_coordinate DECIMAL(10, 2) NOT NULL,
  y_coordinate DECIMAL(10, 2) NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(point_id)
);

CREATE INDEX idx_point_positions_floor ON point_positions(floor_id);
CREATE INDEX idx_point_positions_point ON point_positions(point_id);
```

### Floors Table (Optional Enhancement)
```sql
CREATE TABLE floors (
  id INTEGER PRIMARY KEY,
  name TEXT NOT NULL,
  building_name TEXT,
  map_image_url TEXT,
  display_order INTEGER NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now()
);
```

### Point Discovery Tracking
Track which users have discovered which points for fog-of-war:

```sql
CREATE TABLE point_discoveries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  point_id UUID NOT NULL REFERENCES points(id) ON DELETE CASCADE,
  discovered_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(user_id, point_id)
);

CREATE INDEX idx_point_discoveries_user ON point_discoveries(user_id);
CREATE INDEX idx_point_discoveries_point ON point_discoveries(point_id);
```

### Enemy Point State Cache
Store last-known state of enemy points in browser/client storage:

```typescript
// Client-side cache structure
interface CachedPointState {
  pointId: string;
  health: number;
  maxHealth: number;
  level: number;
  factionId: string;
  lastUpdated: timestamp;
  lastVisited: timestamp;
}
```

---

## Visibility System: Faction Intelligence Model

### Claimable Points Visibility Rules

#### Your Faction's Points (Real-time)
- ‚úÖ Always visible on map
- ‚úÖ Real-time health and level updates via Supabase subscription
- ‚úÖ Show current player count at each point
- ‚úÖ Show recent action history
- ‚úÖ Full strategic information available

#### Enemy Faction Points (Cached State)
- ‚úÖ Always visible on map (location and ownership known)
- ‚ö†Ô∏è Show **last known state** only:
  - Health/level frozen at last visit
  - Cached in browser local storage
  - Display "Last updated: X time ago"
- üîÑ Updates when:
  - Any faction member visits (scans QR)
  - Successful action performed
  - Point captured by your faction (becomes real-time)

#### Unvisited Points (By You)
- ‚úÖ Visible on map as gray markers
- ‚ùå No detailed information shown (name hidden, stats hidden)
- ‚ÑπÔ∏è Can see if owned by your faction (color indicator only)
- üéØ Exception: Your faction's points show full info even if unvisited

#### Visited Points (By You)
- ‚úÖ Name revealed permanently
- ‚úÖ Can see point on mini-map with name
- üîÑ State information follows faction rules above

### Mini-Game Points Visibility Rules
- ‚ùå Completely hidden until discovered
- ‚úÖ Appear on map after first visit (QR scan)
- ‚úÖ Permanent after discovery
- üí° Creates "secret AP farming spots" knowledge
- ü§ù Players can share locations with faction members

### Player Presence Indicators
- Show count of faction members at each point
- Uses `point_user` table for tracking
- Only shows your faction's players
- Real-time updates for coordination

---

## Map Features & UI Components

### MVP Features (Phase 1)

#### 1. Floor Switcher
- Dropdown or tab interface to switch between floors
- Show point count per floor
- Highlight floors with faction-controlled points

#### 2. Point Markers
- **Color Coding**:
  - Your faction: Your faction color
  - Enemy factions: Their faction colors
  - Neutral (unclaimed): Gray
  - Unvisited: Light gray with "?"
  
- **Size**: Based on point level
  - Level 1: Small
  - Level 2: Medium
  - Level 3: Large
  - Level 0: Smallest (unclaimed)

- **Visual States**:
  - Pulse animation: Recently attacked/under contest
  - Opacity/fill: Health percentage indicator
  - Badge: Player count if faction members present

#### 3. Mini-Game Point Markers
- Only visible after discovery
- Distinct icon (e.g., puzzle piece, star)
- Different color scheme (purple/gold)
- No health/level (not claimable)

#### 4. Information Panel (Click on Point)
- Point name (if discovered)
- Point type and level
- Current/max health (if visible per rules)
- Owning faction
- Player presence count
- "Last updated" timestamp (for enemy points)
- Action buttons (if in range via QR)
- Navigation hint (floor number, general direction)

#### 5. Real-time Updates
- Supabase subscription to points table
- Automatic marker updates on:
  - Captures
  - Health changes (for your faction)
  - Player arrivals/departures
  - New discoveries

#### 6. Legend
- Faction color key
- Point type icons
- Level size reference
- Status indicators (contested, healthy, damaged)

### Future Enhancements (Phase 2+)

#### Territory Visualization
- Voronoi diagram showing faction influence
- Heat map of control density
- Percentage bar per floor

#### Strategic Features
- Rally point markers (faction leaders can set)
- Supply lines between connected points
- Contested zone warnings
- Route planning tool

#### Social Features
- Pin messages to locations
- Temporary tactical drawings
- "Last seen here" for faction members
- Share discovered mini-game locations

#### History & Analytics
- Timeline scrubber to see territorial changes
- Faction progress charts
- Personal exploration progress

#### Achievements
- "Cartographer": Discover all mini-game points
- "Scout": First faction member to visit enemy territory
- "Pathfinder": Visit all floors
- "Intelligence Officer": Share 10 enemy point updates

---

## Technical Implementation

### Frontend Stack (Svelte)

#### Recommended: Leaflet.js
- Mature, well-documented mapping library
- Custom tile layers for floor plans
- Good performance with 50+ markers
- Built-in zoom, pan, bounds
- Easy marker clustering

```typescript
// Basic setup
import L from 'leaflet';

const map = L.map('map', {
  crs: L.CRS.Simple, // For indoor maps without geographic coordinates
  minZoom: -2,
  maxZoom: 2
});

// Custom floor plan overlay
const imageUrl = '/floor-plans/floor-1.svg';
const imageBounds = [[0, 0], [1000, 1000]];
L.imageOverlay(imageUrl, imageBounds).addTo(map);
```

#### Alternative: Pixi.js (for more control)
- Game-engine-like rendering
- Better for complex animations
- Custom territory shaders
- Higher learning curve

### Data Flow

```
1. User opens map component
2. Load floor data and current floor selection
3. Subscribe to Supabase realtime:
   - points (for faction's points only)
   - point_user (for player presence)
   - actions (for recent activity)
4. Load point_discoveries for current user
5. Load cached enemy point states from localStorage
6. Filter and render markers based on visibility rules
7. Handle real-time updates:
   - Update marker states
   - Show animations for changes
   - Update cache for visited enemy points
8. On point click:
   - Fetch detailed info (if allowed)
   - Show action panel
   - Check QR proximity for actions
```

### State Management

```typescript
// Svelte stores
export const currentFloor = writable<number>(1);
export const playerPosition = writable<string | null>(null); // Current point_id if scanned
export const discoveredPoints = writable<Set<string>>(new Set());
export const enemyPointCache = writable<Map<string, CachedPointState>>(new Map());
export const visiblePoints = derived(
  [allPoints, currentFloor, discoveredPoints, userFaction],
  ([$points, $floor, $discovered, $faction]) => {
    // Apply visibility rules
    return filterPointsByVisibility($points, $floor, $discovered, $faction);
  }
);
```

### Performance Optimizations

- **Marker Clustering**: Group nearby points at low zoom levels
- **Lazy Loading**: Only load floor data for active floor
- **Debounced Updates**: Batch real-time changes to avoid flickering
- **Canvas Rendering**: For 100+ points, use canvas instead of DOM markers
- **Service Worker Caching**: Cache floor plan images offline

### Local Storage Schema

```typescript
// localStorage keys
const CACHE_KEYS = {
  enemyPoints: 'congress_quest_enemy_cache',
  discoveries: 'congress_quest_discoveries',
  lastFloor: 'congress_quest_last_floor'
};

// Sync with backend periodically
function syncDiscoveries() {
  // Upload local discoveries to point_discoveries table
  // Download new discoveries from server
  // Merge and deduplicate
}
```

---

## Implementation Plan

### Phase 1: MVP (Core Map Functionality)

**Database Changes:**
1. Create `point_positions` table
2. Create `point_discoveries` table
3. Add RLS policies for both tables
4. Create helper functions:
   - `discover_point(user_id, point_id)` - triggered on QR scan
   - `get_user_discoveries(user_id)` - returns discovered point IDs
   - `get_point_last_seen(user_id, point_id)` - returns last visit time

**Backend Functions:**
```sql
-- Automatically mark point as discovered on QR scan
CREATE OR REPLACE FUNCTION mark_point_discovered()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO point_discoveries (user_id, point_id)
  VALUES (NEW.user_id, NEW.point_id)
  ON CONFLICT (user_id, point_id) DO NOTHING;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger when user scans QR (point_user insert)
CREATE TRIGGER on_point_visit
AFTER INSERT ON point_user
FOR EACH ROW
EXECUTE FUNCTION mark_point_discovered();
```

**Frontend Components:**
1. `MapView.svelte` - Main map container
2. `FloorSwitcher.svelte` - Floor selection UI
3. `PointMarker.svelte` - Individual point marker
4. `PointInfoPanel.svelte` - Detail view on click
5. `MapLegend.svelte` - Color/symbol key
6. `MiniMap.svelte` - Small always-visible map overlay

**API Endpoints:**
```typescript
// Load map data for current user
GET /api/map/floors
GET /api/map/points?floor_id=1
GET /api/map/discoveries // Current user's discoveries

// Update enemy cache when visiting
POST /api/map/visit
{
  point_id: string,
  observed_state: {
    health: number,
    level: number,
    faction_id: string
  }
}
```

**Testing Checklist:**
- [ ] Points render on correct floors
- [ ] Faction colors apply correctly
- [ ] Unvisited points show as gray
- [ ] Mini-games hidden until discovered
- [ ] Real-time updates work for faction points
- [ ] Enemy point states cache properly
- [ ] Player count shows correctly
- [ ] Floor switching works smoothly
- [ ] Map scales to different screen sizes

### Phase 2: Enhanced Intelligence

1. Implement faction-wide intelligence sharing
2. Add "Scout" notifications when allies discover enemy changes
3. Implement staleness indicators ("Last updated 2h ago")
4. Add manual intelligence reporting (screenshot/notes)

### Phase 3: Strategic Tools

1. Rally points for faction coordination
2. Territory visualization (Voronoi/heat maps)
3. Route planning between points
4. Attack coordination markers

### Phase 4: Social & Analytics

1. Achievement system for exploration
2. Historical timeline viewer
3. Personal exploration statistics
4. Faction intelligence leaderboard

---

## Design Considerations

### Mobile-First
- Touch-friendly marker sizes (minimum 44px tap target)
- Swipe to switch floors
- Bottom sheet for point info (not modal)
- Pinch-to-zoom support

### Accessibility
- High contrast mode for color-blind users
- Screen reader descriptions for all markers
- Keyboard navigation support
- Text labels option (not just colors)

### Network Resilience
- Offline mode with cached data
- Progressive loading (show partial data while loading)
- Retry failed requests automatically
- Clear indication of stale data

### Security
- Never expose enemy positions server-side
- Rate limit map API calls
- Validate QR scans server-side before revealing info
- Don't leak player positions to enemies

---

## Open Questions

1. **How many total points?** (Affects rendering strategy)
2. **How many floors?** (Affects UI complexity)
3. **Do you have floor plan images/SVGs?**
4. **Should mini-map be always visible or toggle?**
5. **Maximum cache age for enemy points?** (Auto-invalidate after X hours?)
6. **Should admins see full real-time map?**

---

## Brainstormed Ideas (Not in MVP)

### Fog of War Variants

**Pure Fog of War:**
- Everything black except visited locations
- Maximum exploration incentive
- Hard to coordinate (rejected in favor of Faction Intelligence)

**Proximity Reveal:**
- Points within X meters of visited points become visible
- Creates expanding map as you explore
- Natural frontier feeling

**Time-Based Decay:**
- All points visible but info gets stale over time
- Health/ownership ages unless recently confirmed
- Shows "Last updated: 2 hours ago" (‚úÖ Selected for implementation)

### Gamification

**Explorer Achievements:**
- Cartographer: Discover all mini-game points
- Scout: First to visit enemy territory
- Pathfinder: Visit all floors

**Strategic Features:**
- Supply lines between faction points
- Contested zone warnings
- Historical replay of territorial changes
- Rally point marking by faction leaders

**Social Features:**
- Pin messages to map locations
- Draw temporary tactical plans
- Last seen location for faction members
- Share mini-game discoveries

### Advanced Territory Visualization

- Voronoi diagrams showing faction influence
- Heat maps of control density
- Animated territory changes
- 3D view showing all floors at once

---

## Summary of Selected Features for Implementation

Based on the MVP feature list and your specific requirements, here is what will be implemented:

### ‚úÖ Core Map System
- Multi-floor indoor map with floor switcher
- Point positions stored in separate `point_positions` table
- Claimable and mini-game points with distinct markers

### ‚úÖ Faction Intelligence Visibility Model

**Your Faction's Points:**
- Always visible with real-time updates
- Full health, level, and stats shown
- Player presence count visible
- Immediate updates via Supabase subscription

**Enemy Points:**
- Always visible on map (location known)
- Show cached/last known state only
- Health and level frozen at last visit time
- Display "Last updated: X ago" timestamp
- Update when any faction member visits
- Cached in browser local storage

**Unvisited Points:**
- Visible as gray markers on map
- No name or detailed info shown
- Exception: Your faction's points show full info even if you haven't visited

**Visited Points:**
- Name permanently revealed
- Visible on mini-map with name label
- State follows faction intelligence rules

**Mini-Game Points:**
- Hidden until you discover them
- Appear after first QR scan
- Permanent after discovery
- Creates knowledge value for exploration

### ‚úÖ Player Presence
- Show count of your faction members at each point
- Uses `point_user` table
- Real-time updates for coordination
- Does not show enemy player positions

### ‚úÖ Scout Role
- Players who visit enemy territory update intelligence for whole faction
- Creates value in reconnaissance missions
- Encourages exploration of enemy-held areas

### ‚úÖ Technical Implementation
- Leaflet.js for mapping
- Supabase real-time subscriptions
- Local storage for enemy state caching
- `point_discoveries` table for tracking visited points
- Automatic discovery marking on QR scan

This design creates a strategic information warfare layer where reconnaissance has real value, while maintaining exploration incentives through hidden mini-game points and the fog-of-war on unvisited locations.